name: Build
on:
  workflow_dispatch:
  release:
    types: [published]
    
jobs:
  Publish:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Install dependencies
      run: |
           curl -fs https://raw.githubusercontent.com/mafintosh/mount-img/master/install | sh
           sudo apt-get install -y qemu-user-static && sudo systemctl restart systemd-binfmt.service

    - name: Download and unpack image
      run: | 
           wget https://cdimage.ubuntu.com/releases/22.04.1/release/ubuntu-22.04.1-preinstalled-server-arm64+raspi.img.xz -O ubuntu.img.xz
           unxz ubuntu.img.xz
      
    - name: Mount image
      run: |
           mkdir -p ~/mnt
           mount-img ubuntu.img ~/mnt
           
    - name: Apply changes
      run: |
           chmod +x prepare.sh
           ./prepare.sh
           
    - name: Unmount image
      run: sudo umount ~/mnt
      
    - name: Pack image
      run: xz ubuntu.img
    
    - uses: actions/upload-artifact@v3
      with:
        name: ubuntu.img.xz
        path: ubuntu.img.xz
